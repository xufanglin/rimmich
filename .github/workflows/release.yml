name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    name: Build macOS Universal
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin, aarch64-apple-darwin
          components: rust-src

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}-v1

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: |
            /opt/homebrew/Cellar/openssl@3
            /opt/homebrew/opt/openssl@3
          key: homebrew-openssl-${{ runner.os }}-v1
          restore-keys: |
            homebrew-openssl-${{ runner.os }}-

      - name: Install OpenSSL
        run: |
          if ! brew list openssl@3 &>/dev/null; then
            brew install openssl@3
          fi
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig" >> $GITHUB_ENV

      - name: Install Tools
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-binstall, dioxus-cli

      - name: Build for both architectures
        run: |
          # 设置 OpenSSL 环境变量
          export OPENSSL_DIR=$(brew --prefix openssl@3)
          export PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig

          # 使用 cargo 直接构建两种架构
          cargo build --release --target x86_64-apple-darwin
          cargo build --release --target aarch64-apple-darwin

          # 验证文件是否存在
          ls -la target/x86_64-apple-darwin/release/
          ls -la target/aarch64-apple-darwin/release/

          # 创建通用二进制文件
          mkdir -p target/universal-apple-darwin/release
          lipo -create \
            target/x86_64-apple-darwin/release/rimmich \
            target/aarch64-apple-darwin/release/rimmich \
            -output target/universal-apple-darwin/release/rimmich

          # 验证通用二进制文件
          lipo -info target/universal-apple-darwin/release/rimmich

      - name: Create Universal Bundle
        run: |
          # 复制通用二进制文件到默认位置，让 dx bundle 使用
          mkdir -p target/release
          cp target/universal-apple-darwin/release/rimmich target/release/rimmich

          # 使用 dx bundle 创建 DMG，但不指定架构
          dx bundle --desktop --release --package-types "macos" --package-types "dmg"

      - name: Prepare Release Artifacts
        run: |
          mkdir -p release_artifacts
          # 查找生成的 dmg 文件并重命名为 universal
          find . -name "*.dmg" -print0 | while IFS= read -r -d '' file; do
            # 获取原文件名并替换架构标识为 universal
            basename=$(basename "$file")
            new_name=$(echo "$basename" | sed 's/_aarch64\.dmg$/_universal.dmg/' | sed 's/_x86_64\.dmg$/_universal.dmg/')
            cp "$file" "release_artifacts/$new_name"
            echo "Renamed $basename to $new_name"
          done

          # 列出最终的文件
          ls -la release_artifacts/

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: release_artifacts/*
          generate_release_notes: true
